# Инструкция для маршрутизаторов Keenetic:
- [Инструкция для маршрутизаторов Keenetic:](#инструкция-для-маршрутизаторов-keenetic)
  - [OpenVPN](#openvpn)
    - [OpenVPN серверная часть](#openvpn-серверная-часть)
    - [OpenVPN клиентская часть](#openvpn-клиентская-часть)
  - [WireGuard](#wireguard)
    - [WireGuard серверная часть](#wireguard-серверная-часть)
    - [WireGuard клиентская часть](#wireguard-клиентская-часть)
  - [IPsec](#ipsec)
    - [IPsec серверная часть](#ipsec-серверная-часть)
    - [IPsec клиентская часть](#ipsec-клиентская-часть)

## OpenVPN

Это самый удобный и надёжный способ обхода блокировок.

Для более качественной работы OpenVPN рекомендуются новые роутеры Keenetic с быстрыми процессорами (от 1 ГГц) и большим объёмом оперативной памяти (от 256 Мб): Peak (KN-2710), Giga (KN-1012), Hopper (KN-3811/3812), Sprinter (KN-3711/3712), Challenger SE (KN-3911) и Ultra (KN-1811). **Обращайте внимание на номер модели**

Если на старом City KN-1511 скорость канала с контейнером ограничена 6-8 Мбит/с, то на новом Hopper KN-3811 скорость достигает 55-60 Мбит/с

Подробную информацию о различных моделях и скорости работы OpenVPN на них можно найти на [сайте производителя](https://help.keenetic.com/hc/ru/articles/115005342025-Типы-VPN-соединений-в-Keenetic).

### OpenVPN серверная часть
Особых действий не требуется, действовать по [инструкции](https://github.com/xtrime-ru/antizapret-vpn-docker?tab=readme-ov-file#installation). А так же необходимо [выпустить сертификат](https://github.com/xtrime-ru/antizapret-vpn-docker?tab=readme-ov-file#create-client-certificates).

### OpenVPN клиентская часть
1. [Установить компонент "Клиент и сервер OpenVPN"](https://help.keenetic.com/hc/ru/articles/360000880359-%D0%9A%D0%BB%D0%B8%D0%B5%D0%BD%D1%82-%D0%B8-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80-OpenVPN)
2. В файл конфигурации OpenVPN добавить строки:
    ```
    pull-filter ignore block-outside-dns
    route 77.88.8.8
    ```
3. Добавить подключение OpenVPN в разделе `Интернет` > `Другие подключения` > `VPN-подключения` > `Добавить подключение`
   1. Использовать для выхода в интернет: `НЕТ`
   2. Имя подключения: `AntiZapret`
   3. Тип (протокол): `OpenVPN`
   4. Получать маршруты от удаленной стороны: `ДА`
   5. Конфигурация OpenVPN: `Содержимое файла из пункта 2`
   6. `Сохранить`
4. `Сетевые правила` > `Интернет фильтры`
    1. `Настройка DNS` > `Добавить профиль`
       1. Имя профиля: `AntiZapret`
       2. Транзит запросов: `НЕТ`
       3. `Сохранить`
       4. `Добавить сервер`
          1. Тип сервера DNS: `По умолчанию`
          2. IP-адрес: `77.88.8.8`
          3. `Сохранить`
    2. `Контентный фильтр`
         1. Режим фильтрации: `Публичные DNS-резолверы`
         2. Профили контентной фильтрации по умолчанию (`гостевая` и `домашняя`):`AntiZapret`
5. В разделе `Интернет` > `Другие подключения` включаем подключение `AntiZapret`

**Готово!**

## WireGuard
> [!WARNING]
> Для работы Amnezia WireGuard необходима прошивка версии **4.2+**.
> До 4.2 можно использовать обычный WireGuard на порту 443.
> Но сработать может не у всех, рекомендую все таки вариант с Amnezia.

### WireGuard серверная часть
1. Устанавливаем [Docker Engine](https://docs.docker.com/engine/install/):
    ```bash
    curl -fsSL https://get.docker.com -o get-docker.sh
    sudo sh get-docker.sh
    ```
2. Клонируем репозиторий:
    ```
    git clone https://github.com/xtrime-ru/antizapret-vpn-docker.git antizapret
    cd antizapret
    ```
3. Создаем файл `docker-compose.override.yml` со следующим содержанием:
    > Обратите внимание на назначаемый порт WireGuard! 443 лучше обходит блокировки, но может быть расценен вашим хостером как попытка DDoS атаки на ваш сервер. Если возникнут какие-либо лаги или отвалы соединения первым делом смените 443 на какой-либо другой порт!
    ```yaml
    services:
      antizapret:
        environment:
          # Имя пользователя AdGuard Home (задайте свой!)
          - ADGUARDHOME_USERNAME=user
          # Пароль AdGuard Home (задайте свой!)
          - ADGUARDHOME_PASSWORD=somestrongpassword
      # Для Amnezia замените на
      # wireguard-amnezia
      wireguard:
        environment:
          # Пароль панели управления WireGuard (задайте свой!)
          - WIREGUARD_PASSWORD=somestrongpassword
          # Разрешить маршрутизацию всех IP адресов, в маршрутизатор в любом случае в ручном режиме добавляются маршруты
          # Таким образом можно использовать подключение для полноценного VPN
          - WG_ALLOWED_IPS=0.0.0.0/0
          # Принудительное перенаправление всех DNS (udp 53) на antizapret
          # В keenetic прописываем маршрут 77.88.8.8 (или любой другой DNS) на шлюз WG (добавление автоматически)
          # При падении WG, DNS работают напрямую
          - FORCE_FORWARD_DNS=true
          # Язык
          - LANG=ru
          # Порт для панели управления WireGuard
          - PORT=51821
          # Порт WireGuard
          - WG_PORT=443
        ports:
          # Порт для панели управления WireGuard
          - "51821:51821/tcp"
          # Порт WireGuard
          - "443:443/udp"
        extends:
          # Для Amnezia замените на
          # file: docker-compose.wireguard-amnezia.yml
          file: docker-compose.wireguard.yml
          # Для Amnezia замените на
          # service: wireguard-amnezia
          service: wireguard
    ```
4. Собираем контейнер:
   ```
   docker compose pull
   docker compose build
   docker compose up -d
   ```
5. Создаем профиль в WireGuard: `http://<SERVER_IP>:51821`
6. Скачиваем профиль и переходим к клиентской части

> [!NOTE]
> Можно сделать дополнительные настройки в панели управления AdGuard Home: `http://<SERVER_IP>:3000`

### WireGuard клиентская часть
1. [Установить компонент "WireGuard VPN"](https://help.keenetic.com/hc/ru/articles/360010592379-WireGuard-VPN)
2. Загрузить профиль скачанный с панели `Интернет` > `Другие подключения` > `Wireguard` > `Загрузить из файла`
3. Открываем загруженное подключение и ставим галочку на `Использовать для выхода в интернет`, меняем имя на `Antizapret` (необязательно)
4. Добавить подсеть `77.88.8.8/32` к списку `Разрешенных IPv4-подсетей`.
5. `Сетевые правила` > `Маршрутизация`
   1. `Добавить маршрут`
      1. Тип маршрута: `Маршрут до узла`
      2. Описание: `AntiZapretDNS`
      3. Адрес узла назначения: `77.88.8.8`
      4. Адрес шлюза: `пусто`
      5. Интерфейс: `Antizapret` (если не меняли имя, то по имени файла)
      6. Поставить галку `Добавлять автоматически`
   2. `Добавить маршрут`
      1. Тип маршрута: `Маршрут до сети`
      2. Описание: `AntiZapret`
      3. Адрес сети назначения: `10.224.0.0`
      4. Маска подсети: `255.254.0.0/15`
      5. Адрес шлюза: `пусто`
      6. Интерфейс: `Antizapret` (если не меняли имя, то по имени файла)
6. `Сетевые правила` > `Интернет фильтры` > `Настройка DNS`
   1. Имя профиля: `Системный`
   2. Транзит запросов: `НЕТ`
   3. `Сохранить`
   4. `Добавить сервер`
      1. Тип сервера DNS: `По умолчанию`
      2. IP-адрес: `77.88.8.8`
      3. `Сохранить`
7. `Интернет` > `Ethernet`
   1. Найти активное интернет подключение
      1. Поставить галку `Игнорировать DNSv4 интернет-провайдера`
      2. Поставить галку `Игнорировать DNSv6 интернет-провайдера`

> [!NOTE]
> Если используете Amnezia Wireguard, необходимо выполнить еще несколько действий
[инструкции](https://docs.amnezia.org/ru/documentation/instructions/keenetic-os-awg)
начиная с шага 20. Кратко продублирую тут.

1. Переходим в настройки, нажимаем на изображение шестеренки, в правом верхнем углу веб-страницы, и переходим по ссылке `Командная строка`.
2. Отправляем запрос: `show interface`
3. Теперь нужно узнать имя нужного интерфейса, по названию созданного ранее подключения. Для этого, откройте поиск по странице (это можно сделать, одновременно нажав две клавиши, Ctrl+F). Введите для поиска, название созданного ранее подключения. В данном примере, это `AntiZapret` . Должно быть найдено одно уникальное название в поле `description`. А рядом с ним будет находиться другое поле, `interface-name`, в котором отображается имя нужного интерфейса. В данном примере, это `Wireguard1`.
4. Теперь, зная имя интерфейса и значения параметров asc из файла в формате .conf который мы сохранили ранее. Нужно заменить все значения шаблона в скобках, Вашими значениями, а сами скобки удалить.

    `interface {name} wireguard asc {jc} {jmin} {jmax} {s1} {s2} {h1} {h2} {h3} {h4}`

    Для примера, получается вот такая строка:
    `interface Wireguard1 wireguard asc 8 50 1000 30 32 1811016522 1196729875 457766807 1765857463`

    Получившуюся строку, нужно вставить в вэб-версии командной строки роутера, и нажать кнопку "Отправить запрос".
5. Отправляем запрос: `system configuration save`

В разделе `Интернет` > `Другие подключения` включаем подключение `AntiZapret`

**Готово!**

## IPsec
### IPsec серверная часть
В процессе написания

### IPsec клиентская часть
В процессе написания
