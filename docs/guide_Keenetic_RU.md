# Инструкция для маршрутизаторов Keenetic:
- [Инструкция для маршрутизаторов Keenetic:](#инструкция-для-маршрутизаторов-keenetic)
  - [OpenVPN](#openvpn)
    - [OpenVPN серверная часть](#openvpn-серверная-часть)
    - [OpenVPN клиентская часть](#openvpn-клиентская-часть)
  - [WireGuard](#wireguard)
    - [WireGuard серверная часть](#wireguard-серверная-часть)
    - [WireGuard клиентская часть](#wireguard-клиентская-часть)
  - [IPsec](#ipsec)
    - [IPsec серверная часть](#ipsec-серверная-часть)
    - [IPsec клиентская часть](#ipsec-клиентская-часть)

## OpenVPN
### OpenVPN серверная часть
Особых действий не требуется, действовать по [инструкции](https://github.com/xtrime-ru/antizapret-vpn-docker?tab=readme-ov-file#installation).
### OpenVPN клиентская часть
1. [Установить компонент "Клиент и сервер OpenVPN"](https://help.keenetic.com/hc/ru/articles/360000880359-%D0%9A%D0%BB%D0%B8%D0%B5%D0%BD%D1%82-%D0%B8-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80-OpenVPN)
2. В файл конфигурации `antizapret-client-tcp.ovpn` или `antizapret-client-udp.ovpn` OpenVPN добавить строки:
    ```
    pull-filter ignore block-outside-dns
    route 77.88.8.8
    ```
3. Добавить подключение OpenVPN в разделе `Интернет` > `Другие подключения` > `VPN-подключения` > `Добавить подключение`
   1. Использовать для выхода в интернет: `НЕТ`
   2. Имя подключения: `AntiZapret`
   3. Тип (протокол): `OpenVPN`
   4. Получать маршруты от удаленной стороны: `ДА`
   5. Конфигурация OpenVPN: `Содержимое файла из пункта 2`
   6. `Сохранить`
4. `Сетевые правила` > `Интернет фильтры`
    1. `Настройка DNS` > `Добавить профиль`
       1. Имя профиля: `AntiZapret`
       2. Транзит запросов: `НЕТ`
       3. `Сохранить`
       4. `Добавить сервер`
          1. Тип сервера DNS: `По умолчанию`
          2. IP-адрес: `77.88.8.8`
          3. `Сохранить`
    2. `Контентный фильтр`
         1. Режим фильтрации: `Публичные DNS-резолверы`
         2. Профили контентной фильтрации по умолчанию (`гостевая` и `домашняя`):`AntiZapret`
5. В разделе `Интернет` > `Другие подключения` включаем подключение `AntiZapret`

**Готово!**
## WireGuard
> [!WARNING]  
> Для работы Amnezia Wireguard необходима прошивка версии **4.2+**.
> Пока не ввели 4.2 в стабильную ветку можно использовать обычный WireGuard на порту 443.
> Но сработать может не у всех, рекомендую все таки вариант с Amnezia.
### WireGuard серверная часть
1. Устанавливаем [Docker Engine](https://docs.docker.com/engine/install/):
    ```bash
    curl -fsSL https://get.docker.com -o get-docker.sh
    sudo sh get-docker.sh
    ```
    
2. Клонируем репозиторий:
    ```
    git clone https://github.com/xtrime-ru/antizapret-vpn-docker.git antizapret
    cd antizapret
    ```
3. Создаем файл `docker-compose.override.yml` со следующим содержанием:
    ```yaml
    services:
      antizapret-vpn:
        environment:
          - DNS=adguardhome
          - ADGUARD=1
          - OPENVPN_OPTIMIZATIONS=1
          - OPENVPN_TLS_CRYPT=1
          - OPENVPN_PORT=6841
        ports:
          - "6841:1194/tcp"
          - "6841:1194/udp"
        depends_on:
          - adguardhome
      adguardhome:
        extends:
          file: docker-compose.adguard.yml
          service: adguardhome
          container_name: adguardhome
        ports:
          - "6844:3000/tcp"
          - "6845:80/tcp"
      # Для Amnezia замените на
      # amnezia-wg-easy
      wg-easy:
        environment:
          # Сгенерируйте собственный пароль. Установлен пароль: TestGenPa123
          # docker run -it ghcr.io/w0rng/amnezia-wg-easy wgpw "TestGenPa123"
          # Или: https://bcrypt.ninja/
          # Заменяем все $ на $$
          - PASSWORD_HASH=$$2a$$12$$J0lBSna8bUdYhx90SjOqMOtu8O.s7oojtzQE/vKYEEJFjJZ32js2W
          # Разрешить маршрутизацию всех IP адресов, в маршрутизатор в любом случае в ручном режиме добавляются маршруты
          # Таким образом можно использовать подключение для полноценного VPN
          - WG_ALLOWED_IPS=0.0.0.0/0
          # Принудительное перенаправление всех DNS (udp 53) на antizapret
          # В keenetic прописываем маршрут 77.88.8.8 (или любой друго DNS) на шлюз WG (добавление автоматичеки)
          # При падении WG, DNS работают на прямую
          - FORCE_FORWARD_DNS=true
          - LANGUAGE=ru
          - PORT=6843
          - WG_PORT=443
        ports:
          - "443:443/udp"
          - "6843:6843/tcp"
        extends:
          # Для Amnezia замените на
          # file: docker-compose.wireguard-amnezia.yml
          file: docker-compose.wireguard.yml
          # Для Amnezia замените на
          # service: amnezia-wg-easy
          service: wg-easy
    ```
4. Собираем контейнер:
   ```
   docker compose pull
   docker compose up -d
   ```
5. Установка AdGuard Home
   1. Скрипт установки: `http://<SERVER_IP>:6844`
   2. Панель управления: `http://<SERVER_IP>:6845`
6. Создаем профиль в Wireguard: `http://<SERVER_IP>:6843`
7. Скачиваем профиль и переходим к клиентской части
### WireGuard клиентская часть
1. [Установить компонент "WireGuard VPN"](https://help.keenetic.com/hc/ru/articles/360010592379-WireGuard-VPN)
2. Загрузить профиль скачанный с панельки `Интернет` > `Другие подключения` > `Wireguard` > `Загрузить из файла`
3. Открываем загруженое подключение и ставим галочку на `Использовать для выхода в интернет`
   (Не обязательно, меняем имя на `Antizapret`)
4. `Сетевые правила` > `Маршрутизация`
   1. `Добавить маршрут`
      1. Тип маршрута: `Маршрут до узла`
      2. Описание: `AntiZapretDNS`
      3. Адрес узла назначения: `77.88.8.8`
      4. Адрес шлюза: `пусто`
      5. Интерфейс: `Antizapret` (если не меняли имя, то по имени файла)
   2. `Добавить маршрут`
      1. Тип маршрута: `Маршрут до сети`
      2. Описание: `AntiZapret`
      3. Адрес сети назначения: `10.224.0.0`
      4. Маска подсети: `255.254.0.0/15`
      5. Адрес шлюза: `пусто`
      6. Интерфейс: `Antizapret` (если не меняли имя, то по имени файла)
5. `Сетевые правила` > `Интернет фильтры`
    1. `Настройка DNS` > `Добавить профиль`
       1. Имя профиля: `AntiZapret`
       2. Транзит запросов: `НЕТ`
       3. `Сохранить`
       4. `Добавить сервер`
          1. Тип сервера DNS: `По умолчанию`
          2. IP-адрес: `77.88.8.8`
          3. `Сохранить`
    2. `Контентный фильтр`
         1. Режим фильтрации: `Публичные DNS-резолверы`
         2. Профили контентной фильтрации по умолчанию (`гостевая` и `домашняя`): `AntiZapret`
> [!NOTE]  
> Если используете Amnezia Wireguard, необходимо выполнить еще несколько действий
[инструкции](https://docs.amnezia.org/ru/documentation/instructions/keenetic-os-awg)
начиная с шага 20. Кратко продублирую тут.
1. Переходим в настройки, нажимаем на изображение шестеренки, в правом верхнем углу веб-страницы, и переходим по ссылке `Командная строка`.
2. Отправляем запрос: `show interface`
3. Теперь нужно узнать имя нужного интерфейса, по названию созданного ранее подключения. Для этого, откройте поиск по странице (это можно сделать, одновременно нажав две клавиши, Ctrl+F). Введите для поиска, название созданного ранее подключения. В данном примере, это `AntiZapret` . Должно быть найдено одно, уникальное название в поле `description`. А рядом с ним, будет находится другое поле, `interface-name`, в котором отображается имя нужного интерфейса. В данном примере, это `Wireguard1`.
4. Теперь, зная имя интерфейса и значения параметров asc из файла в формате .conf который мы сохранили ранее. Нужно заменить все значения шаблона в скобках, Вашими значениями, а сами скобки удалить.
    
    `interface {name} wireguard asc {jc} {jmin} {jmax} {s1} {s2} {h1} {h2} {h3} {h4}`

    Для примера, получается вот такая строка:
    `interface Wireguard1 wireguard asc 8 50 1000 30 32 1811016522 1196729875 457766807 1765857463`

    Получившуюся строку, нужно вставить в вэб-версии командной строки роутера, и нажать кнопку "Отправить запрос".
5. Отправляем запрос: `system configuration save`

В разделе `Интернет` > `Другие подключения` включаем подключение `AntiZapret`

**Готово!**
## IPsec
### IPsec серверная часть
В процессе написания
### IPsec клиентская часть
В процессе написания